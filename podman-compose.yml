# File: podman-compose.yaml

services:
  # 1. PHP-FPM Application Service
  app:
    container_name: futsal-app
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    volumes:
      - .:/var/www/html
      - /var/www/html/vendor
      - /var/www/html/node_modules
      - ./public/build:/var/www/html/public/build
    env_file:
      - .env
    command: php-fpm
    networks:
      - internal
    # volumes:
    #     - app_storage:/var/www/html/storage

  # 2. Web Server (Nginx) Service with Traefik
  web:
    container_name: futsal-web
    image: nginx:stable-alpine
    restart: always
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - .:/var/www/html:ro
      # - /var/www/html/storage
      # - /var/www/html/bootstrap/cache
      - ./public/build:/var/www/html/public/build:ro
    depends_on:
      - app
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-proxy

      - traefik.http.routers.futsal.rule=Host(`futsal.humahub.my.id`)
      - traefik.http.routers.futsal.entrypoints=websecure
      - traefik.http.routers.futsal.tls=true
      - traefik.http.routers.futsal.tls.certresolver=cf
      - traefik.http.routers.futsal.service=futsal-service

      # Build assets get longer cache
      - traefik.http.routers.futsal-assets.rule=Host(`futsal.humahub.my.id`) && PathPrefix(`/build/`)
      - traefik.http.routers.futsal-assets.entrypoints=websecure
      - traefik.http.routers.futsal-assets.tls=true
      - traefik.http.routers.futsal-assets.tls.certresolver=cf
      - traefik.http.routers.futsal-assets.service=futsal-service
      - traefik.http.routers.futsal-assets.middlewares=futsal-assets-cache

      # Single service for both routers
      - traefik.http.services.futsal-service.loadbalancer.server.port=80
      - traefik.http.middlewares.futsal-assets-cache.headers.customResponseHeaders.Cache-Control=public, max-age=31536000, immutable
    networks:
      # GANTI 'traefik_web' dengan nama network eksternal Traefik Anda
      - traefik-proxy
      - internal

  # 3. Database Service (PostgreSQL)
  # --- PERUBAHAN DI BAWAH INI ---
  db:
    container_name: futsal-db-postgres
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - internal

volumes:
  db_data: # Volume ini sekarang akan digunakan oleh PostgreSQL
  app_storage:

networks:
  internal:
    driver: bridge
  traefik-proxy:
    external: true
