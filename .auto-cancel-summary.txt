‚è∞ AUTO-CANCEL EXPIRED BOOKINGS SYSTEM
=====================================

‚úÖ SYSTEM IMPLEMENTED

üéØ How It Works:

1. USER CREATES ORDER (Checkout)
   ‚Üì
   Booking status = "pending"
   Booking expires_at = now() + 30 minutes
   Booking lock created (30 min)

2. AUTO-CHECK (Every 5 Minutes)
   ‚Üì
   Job runs: CancelExpiredBookings
   Find: Booking WHERE status='pending' AND expires_at < now()
   Action: Cancel + release lock + add note

3. PAYMENT SUCCESS (Within 30 min)
   ‚Üì
   Order status = "paid"
   Booking status = "confirmed"
   Booking expires_at = NULL (cleared)

4. PAYMENT FAILED
   ‚Üì
   Order status = "failed"
   Booking status = "available" (reverted)
   Booking expires_at = NULL (cleared)

‚úÖ FILES CREATED/MODIFIED

New Files:
  ‚úì app/Jobs/CancelExpiredBookings.php
  ‚úì app/Console/Kernel.php
  ‚úì app/Console/Commands/TestCancelExpiredBookings.php
  ‚úì database/migrations/2025_11_09_205519_add_expires_at_to_bookings_table.php
  ‚úì docs/AUTO-CANCEL-BOOKINGS.md

Modified Files:
  ‚úì app/Models/Booking.php (add expires_at to fillable & casts)
  ‚úì app/Services/OrderService.php (set/clear expires_at)

üìä CONFIGURATION

.env settings:
  PAYMENT_TIMEOUT_MINUTES=30     # Default
  PAYMENT_CURRENCY=IDR

Database:
  bookings.expires_at (nullable timestamp)

Scheduler:
  - Every 5 minutes: Run CancelExpiredBookings job
  - Daily at 00:00: Run cleanup

üîß TESTING

Manual test:
  $ php artisan test:cancel-bookings

Check expired bookings:
  $ php artisan tinker
  > \App\Models\Booking::where('status','pending')
      ->where('expires_at','<',now())->get()

View logs:
  $ tail -f storage/logs/laravel.log

üìà STATUS FLOW

Order Created (pending) ‚Üí +30 min timeout
       ‚Üì
   [Two Paths]
   
Path 1: Payment Success
   ‚Üì
Booking CONFIRMED ‚úì
Slot locked permanently
   
Path 2: Timeout (No Payment)
   ‚Üì [Auto-cancel runs]
Booking CANCELLED ‚úó
Slot available for others

üöÄ PRODUCTION SETUP

Add to server crontab:
* * * * * cd /path/to/booking-futsal && php artisan schedule:run >> /dev/null 2>&1

This enables:
  - Automatic booking cancellation
  - Every 5 minute monitoring
  - Daily cleanup at midnight

‚ö†Ô∏è IMPORTANT

‚úì Timezone must be configured in config/app.php
‚úì Cron job MUST be running in production
‚úì Queue driver: database (configured)
‚úì Lock timeout: 30 minutes (configurable)
‚úì Auto-cancel logs saved to storage/logs/laravel.log

üìù EXAMPLE LOG OUTPUT

[2025-11-09 21:05:00] local.INFO: Auto-cancelled 2 expired bookings
[2025-11-09 21:10:00] local.INFO: Auto-cancelled 1 expired bookings
[2025-11-09 21:15:00] local.INFO: No expired bookings found

‚úÖ SYSTEM STATUS: READY FOR PRODUCTION

When user doesn't pay within 30 minutes:
  ‚úì Booking automatically cancelled
  ‚úì Slot becomes available
  ‚úì Other users can book that time
  ‚úì Lock is released
  ‚úì Order marked as expired/failed
